#!/bin/bash

declare -r -i DEFAULT_NUM_QUERIES=100
declare -i NUM_QUERIES=${DEFAULT_NUM_QUERIES}

declare -r DEFAULT_BURST_SIZE=14
declare BURST_SIZE=${DEFAULT_BURST_SIZE}

declare -r DEFAULT_NUM_WORKERS=100
declare NUM_WORKERS=${DEFAULT_NUM_WORKERS}

declare SANDBOX=off

declare -r -i DEFAULT_CPUS=100
declare -i CPUS=${DEFAULT_CPUS}
declare -r DEFAULT_MEMORY=100G
declare MEMORY=${DEFAULT_MEMORY}

declare -r DEFAULT_QPS="10:5:100"
declare QPS="${DEFAULT_QPS}"

function usage() {
  local exitval=${1-1}
  cat &>/dev/stderr << USAGE
usage:
  $0 <options>
  Traffic generator settings:
    --num-queries <int>        number of queries to execute. Default: ${DEFAULT_NUM_QUERIES}.
    --burst-size <range>         number of RPCs within a burst. Default: ${DEFAULT_BURST_SIZE}.
    --num-workers <range>      number of workers to execute, as an integer or a range (min:increment:max or min:max). Default: ${DEFAULT_NUM_WORKERS}.
    --num-qps <range>          queries per second, as an integer or a range (min:increment:max or min:max). Default: ${DEFAULT_QPS}.

  Container settings:
    --cpus <int>               CPU count allocated to the container. Default: ${DEFAULT_CPUS}.
    --memory <value>           memory to allocate to the container. Default: ${DEFAULT_MEMORY}.

  where <range> should be one of:
    * a single integer
    * two or three integers, colon-delimited. The colons are replaced with whitespace, then passed
      as arguments to the seq program. Therefore, the range value should be one of:
        * a string with two integers "a:b" where a <= b
        * a string with three integers "a:x:c" where a <= b, and x is the increment

USAGE
  # shellcheck disable=SC2086
  exit ${exitval}
}

while [[ $# -gt 0 ]]; do
  case "$1" in
    --num-queries) NUM_QUERIES=$2; shift 2 || usage 1 ;;
    --burst-size) BURST_SIZE="$2"; shift 2 || usage 1 ;;
    --num-workers) NUM_WORKERS="$2"; shift 2 || usage 1 ;;
    --num-qps) QPS="$2"; shift 2 || usage 1 ;;

    --cpus) CPUS=$2; shift 2 || usage 1 ;;
    --memory) MEMORY="$2"; shift 2 || usage 1 ;;
    -h | --help) usage 0 ;;
    *)
      printf "unrecognized arg: %s\n" "$1"
      usage
      ;;
  esac
done


IMAGE=privacy-sandbox/roma-byob/traffic_generator:v1-root

declare -i FAILURE_COUNT=0
declare -r -i MAX_FAILURES=1

declare -a -r DOCKER_ARGS=(
  "--privileged"
  "--cpus=${CPUS}"
  "--memory=${MEMORY}"
)

function run_test() {
  declare -r -i burst_size=$1; shift
  declare -r -i qps=$1; shift
  declare -r -i num_workers=$1; shift
  printf "running qps: %d\n" ${qps}
  set -o xtrace
  if ! docker run \
    "${DOCKER_ARGS[@]}" \
    "${IMAGE}" \
    --burst_size="${burst_size}" \
    --num_queries="${NUM_QUERIES}" \
    --sandbox="${SANDBOX}" \
    --num_workers="${num_workers}" \
    --queries_per_second="${qps}"; then
    FAILURE_COUNT=$((FAILURE_COUNT+1))
  fi
}

function check_range() {
  declare -n _val=$1
  if [[ ${_val} -ge 0 ]] 2>/dev/null; then
    _val="${_val}:${_val}"
  fi
}

check_range QPS
check_range NUM_WORKERS
check_range BURST_SIZE

set -o xtrace
# shellcheck disable=SC2086,SC2207
declare -a QPS_LIST=($(seq ${QPS//:/ }))
# shellcheck disable=SC2086,SC2207
declare -a NUM_WORKERS_LIST=($(seq ${NUM_WORKERS//:/ }))
# shellcheck disable=SC2086,SC2207
declare -a BURST_SIZE_LIST=($(seq ${BURST_SIZE//:/ }))

declare -i qps num_workers burst_size
for qps in "${QPS_LIST[@]}"; do
  for num_workers in "${NUM_WORKERS_LIST[@]}"; do
    for burst_size in "${BURST_SIZE_LIST[@]}"; do
      run_test ${burst_size} ${qps} ${num_workers}
      if [[ ${FAILURE_COUNT} -ge ${MAX_FAILURES} ]]; then
        printf "%d failures. Exiting\n" ${FAILURE_COUNT}
        exit 1
      fi
    done
  done
done
